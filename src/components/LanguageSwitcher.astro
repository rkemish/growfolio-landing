---
// Language Switcher dropdown component
import { LANGUAGES, LANGUAGES_BY_COUNTRY, type SupportedLocale } from '../i18n/config';
import { getLocalizedUrl } from '../i18n/utils';

const currentLang = ((Astro.locals as any).lang as SupportedLocale) || 'en';
const currentUrl = Astro.url;

// Get language info
const currentLangInfo = LANGUAGES[currentLang];
---

<div class="language-switcher relative">
  <button
    class="lang-toggle flex items-center gap-1.5 px-2.5 py-1.5 rounded-lg text-sm font-medium transition-colors hover:bg-black/5"
    aria-expanded="false"
    aria-haspopup="listbox"
    aria-label="Select language"
  >
    <span class="text-base" aria-hidden="true">{currentLangInfo.flag}</span>
    <span class="hidden sm:inline text-gray-700">{currentLangInfo.nativeName}</span>
    <svg class="w-3.5 h-3.5 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M6 9l6 6 6-6"></path>
    </svg>
  </button>

  <div
    class="lang-dropdown absolute top-full right-0 mt-2 w-72 max-h-96 overflow-hidden bg-white rounded-xl shadow-2xl border border-gray-100 opacity-0 invisible transition-all duration-200 z-50"
    role="listbox"
    aria-label="Available languages"
  >
    <!-- Search input -->
    <div class="p-2 border-b border-gray-100">
      <div class="relative">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="M21 21l-4.35-4.35"></path>
        </svg>
        <input
          type="text"
          placeholder="Search languages..."
          class="lang-search w-full pl-9 pr-3 py-2 text-sm rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-teal-500/50 focus:border-teal-500"
        />
      </div>
    </div>

    <div class="overflow-y-auto max-h-80">
      {LANGUAGES_BY_COUNTRY.map((countryGroup, index) => (
        <div class={`p-2 ${index > 0 ? 'border-t border-gray-100' : ''}`} data-country={countryGroup.country}>
          <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider px-2 py-1 flex items-center gap-1.5">
            <span>{countryGroup.flag}</span>
            <span>{countryGroup.country}</span>
          </div>
          {countryGroup.languages.map((code) => {
            const lang = LANGUAGES[code];
            const isActive = code === currentLang;
            return (
              <a
                href={getLocalizedUrl(currentUrl, code)}
                class={`lang-option flex items-center gap-3 px-3 py-2 rounded-lg text-sm transition-colors ${
                  isActive ? 'bg-teal-50 text-teal-700' : 'hover:bg-gray-50 text-gray-700'
                }`}
                role="option"
                aria-selected={isActive}
                data-lang={code}
                data-name={`${lang.name} ${lang.nativeName} ${countryGroup.country}`.toLowerCase()}
              >
                <span class="text-lg">{lang.flag}</span>
                <span class="flex-1">{lang.nativeName}</span>
                <span class="text-xs text-gray-400">{lang.name}</span>
                {isActive && (
                  <svg class="w-4 h-4 text-teal-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 13l4 4L19 7"></path>
                  </svg>
                )}
              </a>
            );
          })}
        </div>
      ))}
    </div>
  </div>
</div>

<script>
  function initLanguageSwitchers() {
    // Find all language switcher instances and initialize each one
    const switchers = document.querySelectorAll('.language-switcher');

    switchers.forEach((switcher) => {
      const toggle = switcher.querySelector('.lang-toggle') as HTMLButtonElement;
      const dropdown = switcher.querySelector('.lang-dropdown') as HTMLElement;
      const search = switcher.querySelector('.lang-search') as HTMLInputElement;
      const options = switcher.querySelectorAll('.lang-option');

      if (!toggle || !dropdown) return;

      // Skip if already initialized
      if (toggle.dataset.initialized) return;
      toggle.dataset.initialized = 'true';

      // Toggle dropdown
      function openDropdown() {
        dropdown.classList.remove('opacity-0', 'invisible');
        dropdown.classList.add('opacity-100', 'visible');
        toggle.setAttribute('aria-expanded', 'true');
        setTimeout(() => search?.focus(), 50);
      }

      function closeDropdown() {
        dropdown.classList.remove('opacity-100', 'visible');
        dropdown.classList.add('opacity-0', 'invisible');
        toggle.setAttribute('aria-expanded', 'false');
        if (search) search.value = '';
        options.forEach(opt => (opt as HTMLElement).style.display = 'flex');
        // Reset country groups visibility within this dropdown
        dropdown.querySelectorAll('[data-country]').forEach(group => {
          (group as HTMLElement).style.display = 'block';
        });
      }

      toggle.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = dropdown.classList.contains('opacity-100');
        if (isOpen) {
          closeDropdown();
        } else {
          openDropdown();
        }
      });

      // Search filter
      search?.addEventListener('input', (e) => {
        const query = (e.target as HTMLInputElement).value.toLowerCase();
        const countryGroups = dropdown.querySelectorAll('[data-country]');

        options.forEach(option => {
          const name = option.getAttribute('data-name') || '';
          const matches = name.includes(query);
          (option as HTMLElement).style.display = matches ? 'flex' : 'none';
        });

        // Hide empty country groups
        countryGroups.forEach(group => {
          const hasVisible = Array.from(group.querySelectorAll('.lang-option')).some(
            opt => (opt as HTMLElement).style.display !== 'none'
          );
          (group as HTMLElement).style.display = hasVisible ? 'block' : 'none';
        });
      });

      // Close on click outside
      document.addEventListener('click', (e) => {
        if (!toggle.contains(e.target as Node) && !dropdown.contains(e.target as Node)) {
          closeDropdown();
        }
      });

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && dropdown.classList.contains('opacity-100')) {
          closeDropdown();
          toggle.focus();
        }
      });
    });
  }

  // Initialize on page load
  initLanguageSwitchers();

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:after-swap', initLanguageSwitchers);
</script>
